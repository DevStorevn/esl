<!DOCTYPE html>

<html>
<head>
  <title>Connection Listener (socket events handler)</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="esl.coffee.html">
                  esl.coffee.md
                </a>
              
                
                <a class="source" href="parser.coffee.html">
                  parser.coffee.md
                </a>
              
                
                <a class="source" href="response.coffee.html">
                  response.coffee.md
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="connection-listener-socket-events-handler-">Connection Listener (socket events handler)</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>We use the same connection-listener for both client (FreeSwitch “inbound” socket) and server (FreeSwitch “outound” socket).
This is modelled after Node.js’ http.js; the connection-listener is called either when FreeSwitch connects to our server, or when we connect to FreeSwitch from our client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">connectionListener</span> = <span class="hljs-params">(call)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The module provides statistics in the <code>stats</code> object. You may use it  to collect your own call-related statistics. For example the <a href="https://github.com/shimaore/tough-rate">tough-rate</a> LCR engine uses this along with the <a href="https://github.com/shimaore/caring-band">caring-band</a> data collection tool to provide realtime data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  call.stats ?= {}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The parser will be the one receiving the actual data from the socket. We will process the parser’s output below.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parser = <span class="hljs-keyword">new</span> FreeSwitchParser call.socket</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Make the command responses somewhat unique. This is required since FreeSwitch doesn’t provide us a way to match response with requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  call.<span class="hljs-literal">on</span> <span class="hljs-string">'CHANNEL_EXECUTE_COMPLETE'</span>, <span class="hljs-function"><span class="hljs-params">(res)</span> -&gt;</span>
    application = res.body[<span class="hljs-string">'Application'</span>]
    application_data = res.body[<span class="hljs-string">'Application-Data'</span>] ? <span class="hljs-string">''</span>
    call.emit <span class="hljs-string">"CHANNEL_EXECUTE_COMPLETE <span class="hljs-subst">#{application}</span> <span class="hljs-subst">#{application_data}</span>"</span>, res
    unique_id = res.body[<span class="hljs-string">'Unique-ID'</span>]
    <span class="hljs-keyword">if</span> unique_id?
      call.emit <span class="hljs-string">"CHANNEL_EXECUTE_COMPLETE <span class="hljs-subst">#{unique_id}</span> <span class="hljs-subst">#{application}</span> <span class="hljs-subst">#{application_data}</span>"</span>, res</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The parser is responsible for de-framing messages coming from FreeSwitch and splitting it into headers and a body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parser.process = <span class="hljs-function"><span class="hljs-params">(headers,body)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Rewrite headers as needed to work around some weirdnesses in the protocol; and assign unified event IDs to the Event Socket’s Content-Types.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    content_type = headers[<span class="hljs-string">'Content-Type'</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> content_type?
      call.stats.missing_content_type ?= <span class="hljs-number">0</span>
      call.stats.missing_content_type++
      call.socket.emit <span class="hljs-string">'error'</span>, {<span class="hljs-attribute">when</span>: <span class="hljs-string">'Missing Content-Type'</span>, headers, body}
      <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Notice how all our (internal) event names are lower-cased; FreeSwitch always uses full-upper-case event names.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">switch</span> content_type</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="auth-request">auth/request</h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>FreeSwitch sends an authentication request when a client connect to the Event Socket.
Normally caught by the client code, there is no need for your code to monitor this event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">when</span> <span class="hljs-string">'auth/request'</span>
        event = <span class="hljs-string">'freeswitch_auth_request'</span>
        call.stats.auth_request ?= <span class="hljs-number">0</span>
        call.stats.auth_request++</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="command-reply">command/reply</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Commands trigger this type of event when they are submitted.
Normally caught by <code>send</code>, there is no need for your code to monitor this event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">when</span> <span class="hljs-string">'command/reply'</span>
        event = <span class="hljs-string">'freeswitch_command_reply'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Apparently a bug in the response to <code>connect</code> causes FreeSwitch to send the headers in the body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> headers[<span class="hljs-string">'Event-Name'</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'CHANNEL_DATA'</span>
          body = headers
          headers = {}
          <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> [<span class="hljs-string">'Content-Type'</span>,<span class="hljs-string">'Reply-Text'</span>,<span class="hljs-string">'Socket-Mode'</span>,<span class="hljs-string">'Control'</span>]
            headers[n] = body[n]
            <span class="hljs-keyword">delete</span> body[n]
        call.stats.command_reply ?= <span class="hljs-number">0</span>
        call.stats.command_reply++</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="text-event-json">text/event-json</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>A generic event with a JSON body. We map it to its own Event-Name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">when</span> <span class="hljs-string">'text/event-json'</span>
        <span class="hljs-keyword">try</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Strip control characters that might be emitted by FreeSwitch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          body = body.replace <span class="hljs-regexp">/[\x00-\x1F\x7F-\x9F]/g</span>, <span class="hljs-string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Parse the JSON body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          body = JSON.parse(body)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>In case of error report it as an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">catch</span> exception
          call.stats.json_parse_errors ?= <span class="hljs-number">0</span>
          call.stats.json_parse_errors++
          call.socket.emit <span class="hljs-string">'error'</span>, <span class="hljs-attribute">when</span>:<span class="hljs-string">'JSON error'</span>, <span class="hljs-attribute">error</span>:exception, <span class="hljs-attribute">body</span>:body
          <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Otherwise trigger the proper event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        event = body[<span class="hljs-string">'Event-Name'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="text-event-plain">text/event-plain</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Same a <code>text/event-json</code> except the body is encoded using plain text. Either way the module provides you with a parsed body (a hash/Object).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">when</span> <span class="hljs-string">'text/event-plain'</span>
        body = parse_header_text(body)
        event = body[<span class="hljs-string">'Event-Name'</span>]
        call.stats.events ?= <span class="hljs-number">0</span>
        call.stats.events++</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="log-data">log/data</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">when</span> <span class="hljs-string">'log/data'</span>
        event = <span class="hljs-string">'freeswitch_log_data'</span>
        call.stats.log_data ?= <span class="hljs-number">0</span>
        call.stats.log_data++</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="text-disconnect-notice">text/disconnect-notice</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>FreeSwitch’s indication that it is disconnecting the socket.
You normally do not have to monitor this event; the <code>autocleanup</code> methods catches this event and emits either <code>freeswitch_disconnect</code> or <code>freeswitch_linger</code>, monitor those events instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">when</span> <span class="hljs-string">'text/disconnect-notice'</span>
        event = <span class="hljs-string">'freeswitch_disconnect_notice'</span>
        call.stats.disconnect ?= <span class="hljs-number">0</span>
        call.stats.disconnect++</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="api-response">api/response</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Triggered when an <code>api</code> message returns. Due to the inability to map those responses to requests, you might want to use <code>queue_api</code> instead of <code>api</code> for concurrent usage.
You normally do not have to monitor this event, the <code>api</code> methods catches it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">when</span> <span class="hljs-string">'api/response'</span>
        event = <span class="hljs-string">'freeswitch_api_response'</span>
        call.stats.api_responses ?= <span class="hljs-number">0</span>
        call.stats.api_responses++</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="others-">Others?</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Ideally other content-types should be individually specified. In any case we provide a fallback mechanism.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        debug <span class="hljs-string">'Unhandled Content-Type'</span>, content_type
        event = <span class="hljs-string">"freeswitch_<span class="hljs-subst">#{content_type.replace <span class="hljs-regexp">/[^a-z]/</span>, <span class="hljs-string">'_'</span>}</span>"</span>
        call.socket.emit <span class="hljs-string">'error'</span>, <span class="hljs-attribute">when</span>:<span class="hljs-string">'Unhandled Content-Type'</span>, <span class="hljs-attribute">error</span>:content_type
        call.stats.unhandled ?= <span class="hljs-number">0</span>
        call.stats.unhandled++</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2 id="event-content">Event content</h2>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>The messages sent at the server- or client-level only contain the headers and the body, possibly modified by the above code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    msg = {headers,body}

    outcome = call.emit event, msg</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2 id="get-things-started">Get things started</h2>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Get things started: notify the application that the connection is established and that we are ready to send commands to FreeSwitch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  call.emit <span class="hljs-string">'freeswitch_connect'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h1 id="server">Server</h1>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>The server is used when FreeSwitch needs to be able to initiate a connection to us so that we can handle an existing call.</p>
<p>We inherit from the <code>Server</code> class of Node.js’ <code>net</code> module. This way any method from <code>Server</code> may be re-used (although in most cases only <code>listen</code> is used).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>net = <span class="hljs-built_in">require</span> <span class="hljs-string">'net'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreeSwitchServer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">net</span>.<span class="hljs-title">Server</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(requestListener)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>The server also contains a <code>stats</code> object. It records the number of connections.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@stats</span> = {}
    <span class="hljs-property">@on</span> <span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-params">(socket)</span> -&gt;</span>
      <span class="hljs-property">@stats</span>.connections ?= <span class="hljs-number">0</span>
      <span class="hljs-property">@stats</span>.connections++</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>For every new connection to our server we get a new <code>Socket</code> object, which we wrap inside our <code>FreeSwitchResponse</code> object. This becomes the <code>call</code> object used throughout the application.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      call = <span class="hljs-keyword">new</span> FreeSwitchResponse socket</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>The <code>freeswitch_connect</code> event is triggered by our <code>connectionListener</code> once the parser is set up and ready.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      call.once <span class="hljs-string">'freeswitch_connect'</span>
      .<span class="hljs-keyword">then</span> -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>The request-listener is called within the context of the <code>FreeSwitchResponse</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">try</span>
          requestListener.call call</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>All errors are reported directly on the socket; even though <code>FreeSwitchResponse</code> contains an <code>EventEmitter</code> we don’t use it for error notification.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">catch</span> exception
          call.socket.emit <span class="hljs-string">'error'</span>, exception</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>The connection-listener is called last to set the parser up and trigger the request-listener.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      connectionListener call

    <span class="hljs-keyword">super</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>The <code>server</code> we export is only slightly more complex. It sets up a filter so that the application only gets its own events, and sets up automatic cleanup which will be used before disconnecting the socket.
The call handler will receive a <code>FreeSwitchResponse</code> object, <code>options</code> are optional (and currently unused).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.server = <span class="hljs-function"><span class="hljs-params">(options = {}, handler, report = error)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> options <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    [options,handler] = [{},options]

  assert.ok handler?, <span class="hljs-string">"server handler is required"</span>
  assert.strictEqual <span class="hljs-keyword">typeof</span> handler, <span class="hljs-string">'function'</span>, <span class="hljs-string">"server handler must be a function"</span>

  server = <span class="hljs-keyword">new</span> FreeSwitchServer -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Here starts our default request-listener.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">try</span>
      Unique_ID = <span class="hljs-string">'Unique-ID'</span>
      server.stats.connecting ?= <span class="hljs-number">0</span>
      server.stats.connecting++</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Confirm connection with FreeSwitch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@connect</span>()
      .<span class="hljs-keyword">then</span> (res) -&gt;
        <span class="hljs-property">@data</span> = res.body
        <span class="hljs-property">@uuid</span> = <span class="hljs-property">@data</span>[Unique_ID]</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Restricting events using <code>filter</code> is required so that <code>event_json</code> will only obtain our events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@filter</span> Unique_ID, <span class="hljs-property">@uuid</span>
      .<span class="hljs-keyword">then</span> -&gt;
        <span class="hljs-property">@auto_cleanup</span>()
        server.stats.handler ?= <span class="hljs-number">0</span>
        server.stats.handler++</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Subscribing to <code>event_json &#39;ALL&#39;</code> is required to e.g. obtain <code>CHANNEL_EXECUTE_COMPLETE</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .<span class="hljs-keyword">then</span> -&gt; <span class="hljs-property">@event_json</span> <span class="hljs-string">'ALL'</span>
      .<span class="hljs-keyword">then</span> handler

    <span class="hljs-keyword">catch</span> exception
      report exception

  debug <span class="hljs-string">"Ready to start <span class="hljs-subst">#{pkg.name}</span> <span class="hljs-subst">#{pkg.version}</span> server."</span>
  <span class="hljs-keyword">return</span> server</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h1 id="client">Client</h1>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Client mode is used to place new calls or take over existing calls.</p>
<p>We inherit from the <code>Socket</code> class of Node.js’ <code>net</code> module. This way any method from <code>Socket</code> may be re-used (although in most cases only <code>connect</code> is used).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreeSwitchClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">net</span>.<span class="hljs-title">Socket</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Contrarily to the server which will handle multiple socket connections over its lifetime, a client only handles one socket, so only one <code>FreeSwitchResponse</code> object is needed as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@call</span> = <span class="hljs-keyword">new</span> FreeSwitchResponse <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Parsing of incoming messages is handled by the connection-listener.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@on</span> <span class="hljs-string">'connect'</span>, <span class="hljs-function">=&gt;</span>
      connectionListener <span class="hljs-property">@call</span>
    <span class="hljs-keyword">super</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>The <code>client</code> function we provide wraps <code>FreeSwitchClient</code> in order to provide some defaults.
The <code>handler</code> will be called in the context of the <code>FreeSwitchResponse</code>; the <code>options</code> are optional, but may include a <code>password</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.default_password = <span class="hljs-string">'ClueCon'</span>

exports.client = <span class="hljs-function"><span class="hljs-params">(options = {}, handler, errorHandler)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> options <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    [options,handler,errorHandler] = [{},options,handler]</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>If neither <code>options</code> not <code>password</code> is provided, the default password is assumed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  options.password ?= exports.default_password

  assert.ok handler?, <span class="hljs-string">"client handler is required"</span>
  assert.strictEqual <span class="hljs-keyword">typeof</span> handler, <span class="hljs-string">'function'</span>, <span class="hljs-string">"client handler must be a function"</span>

  client = <span class="hljs-keyword">new</span> FreeSwitchClient()</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Normally when the client connects, FreeSwitch will first send us an authentication request. We use it to trigger the remainder of the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client.call.once <span class="hljs-string">'freeswitch_auth_request'</span>
  .<span class="hljs-keyword">then</span> -&gt;
    <span class="hljs-property">@auth</span> options.password
  .<span class="hljs-keyword">then</span> -&gt; <span class="hljs-property">@auto_cleanup</span>()
  .<span class="hljs-keyword">then</span> handler, errorHandler

  debug <span class="hljs-string">"Ready to start <span class="hljs-subst">#{pkg.name}</span> <span class="hljs-subst">#{pkg.version}</span> client."</span>
  <span class="hljs-keyword">return</span> client</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Please note that the client is not started with <code>event_json</code> since by default this would mean obtaining all events from FreeSwitch.
You must manually run <code>@event_json</code> and an optional <code>@filter</code> command.</p>
<h2 id="toolbox">Toolbox</h2>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>assert = <span class="hljs-built_in">require</span> <span class="hljs-string">'assert'</span>
{error} = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>

FreeSwitchParser = <span class="hljs-built_in">require</span> <span class="hljs-string">'./parser'</span>
FreeSwitchResponse = <span class="hljs-built_in">require</span> <span class="hljs-string">'./response'</span>
{parse_header_text} = FreeSwitchParser

pkg = <span class="hljs-built_in">require</span> <span class="hljs-string">'../package.json'</span>
debug = (<span class="hljs-built_in">require</span> <span class="hljs-string">'debug'</span>) <span class="hljs-string">'esl:main'</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
