<!DOCTYPE html>

<html>
<head>
  <title>Event Socket stream parser</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="esl.coffee.html">
                  esl.coffee.md
                </a>
              
                
                <a class="source" href="parser.coffee.html">
                  parser.coffee.md
                </a>
              
                
                <a class="source" href="response.coffee.html">
                  response.coffee.md
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="event-socket-stream-parser">Event Socket stream parser</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>querystring = <span class="hljs-built_in">require</span> <span class="hljs-string">'querystring'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreeSwitchParserError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span></span>
  constructor: <span class="hljs-function"><span class="hljs-params">(@error,@buffer)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> JSON.stringify {error:@error,buffer:@buffer}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreeSwitchParser</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The Event Socket parser will parse an incoming ES stream, whether your code is acting as a client (connected to the FreeSwitch ES server) or as a server (called back by FreeSwitch due to the “socket” application command).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-params">(@socket)</span> -&gt;</span>
    @body_length = <span class="hljs-number">0</span>
    @buffer = <span class="hljs-keyword">new</span> Buffer <span class="hljs-number">0</span>
    @buffer_length = <span class="hljs-number">0</span>

    @socket.<span class="hljs-literal">on</span> <span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(data)</span> =&gt;</span>
      @on_data data

    @socket.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>, <span class="hljs-function">=&gt;</span>
      @on_end()</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3 id="capture-body">Capture body</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  capture_body: <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>When capturing the body, <code>buffer</code> contains the current data (text), and <code>body_length</code> contains how many bytes are expected to be read in the body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @buffer_length += data.length
    @buffer = Buffer.concat [@buffer, data], @buffer_length</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>As long as the whole body hasn’t been received, keep adding the new data into the buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> @buffer_length &lt; @body_length
      <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Consume the body once it has been fully received.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    body = @buffer.toString <span class="hljs-string">'utf8'</span>, <span class="hljs-number">0</span>, @body_length
    @buffer = @buffer.slice @body_length
    @buffer_length -= @body_length
    @body_length = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Process the content at each step.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @process @headers, body
    @headers = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Re-parse whatever data was left after the body was fully consumed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @capture_headers <span class="hljs-keyword">new</span> Buffer <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="capture-headers">Capture headers</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  capture_headers: <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Capture headers, meaning up to the first blank line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @buffer_length += data.length
    @buffer = Buffer.concat [@buffer, data], @buffer_length</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Wait until we reach the end of the header.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    header_end = @buffer.indexOf <span class="hljs-string">'\n\n'</span>
    <span class="hljs-keyword">if</span> header_end &lt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Consume the headers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    header_text = @buffer.toString <span class="hljs-string">'utf8'</span>, <span class="hljs-number">0</span>, header_end
    @buffer = @buffer.slice header_end+<span class="hljs-number">2</span>
    @buffer_length -= header_end+<span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Parse the header lines</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    @headers = parse_header_text header_text</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Figure out whether a body is expected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> @headers[<span class="hljs-string">"Content-Length"</span>]
      @body_length = @headers[<span class="hljs-string">"Content-Length"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Parse the body (and eventually process)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      @capture_body <span class="hljs-keyword">new</span> Buffer <span class="hljs-number">0</span>

    <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Process the (header-only) content</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      @process @headers
      @headers = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Re-parse whatever data was left after these headers were fully consumed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      @capture_headers <span class="hljs-keyword">new</span> Buffer <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3 id="dispatch-incoming-data-into-the-header-or-body-parsers-">Dispatch incoming data into the header or body parsers.</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  on_data: <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Capture the body as needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> @body_length &gt; <span class="hljs-number">0</span>
      <span class="hljs-keyword">return</span> @capture_body data
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> @capture_headers data</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>For completeness provide an <code>on_end()</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  on_end: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">if</span> @buffer_length &gt; <span class="hljs-number">0</span>
      @socket.emit <span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> FreeSwitchParserError <span class="hljs-string">'Buffer is not empty at end of stream'</span>, @buffer</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h1 id="headers-parser">Headers parser</h1>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Event Socket framing contains headers and a body.
The header must be decoded first to learn the presence and length of the body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">parse_header_text</span> = <span class="hljs-params">(header_text)</span> -&gt;</span>

  header_lines = header_text.split <span class="hljs-string">'\n'</span>
  headers = {}
  <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> header_lines
    <span class="hljs-keyword">do</span> (line) -&gt;
      [name,value] = line.split <span class="hljs-regexp">/: /</span>, <span class="hljs-number">2</span>
      headers[name] = value</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Decode headers: in the case of the “connect” command, the headers are all URI-encoded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> headers[<span class="hljs-string">'Reply-Text'</span>]?[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'%'</span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">of</span> headers
      headers[name] = querystring.unescape(headers[name])

  <span class="hljs-keyword">return</span> headers

<span class="hljs-built_in">module</span>.exports.parse_header_text = parse_header_text</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
